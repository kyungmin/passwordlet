(function(e,a,g,h,f,c,b,d){if(!(f=e.jQuery)||g>f.fn.jquery||h(f)){c=a.createElement("script");c.type="text/javascript";c.src="https://ajax.googleapis.com/ajax/libs/jquery/"+g+"/jquery.min.js";c.onload=c.onreadystatechange=function(){if(!b&&(!(d=this.readyState)||d=="loaded"||d=="complete")){h((f=e.jQuery).noConflict(1),b=1);f(c).remove()}};a.getElementsByTagName("head")[0].appendChild(c)}})(window,document,"1.3.2",function($,L){

  showOverlay("Connecting to Passwordlet..");

  $.ajax({
    type: "GET",
    url: "https://gentle-taiga-4945.herokuapp.com/bookmarklet/signed_in",
    dataType: "jsonp",
    async: false,
    contentType: "application/json",
    success: function(data) {
      if (data.message == "not signed in") {
        showOverlay("Please log in to Passwordlet.");
        setTimeout(function() {
          showPasswordlet("https://gentle-taiga-4945.herokuapp.com/users/sign_in");
          hideOverlay();
        }, 1000);
      } else {
        $.ajax({
          type: "GET",
          url: "https://gentle-taiga-4945.herokuapp.com/domains/login",
          data: { domain: location.hostname },
          dataType: "jsonp",
          async: false,
          contentType: "application/json",
          success: function(data) {
            hideOverlay();

            if (data.message == "domain not found") {
              showOverlay("This domain is not registered in Passwordlet.");
              setTimeOut(function() {
                showPasswordlet("https://gentle-taiga-4945.herokuapp.com/domains/new");
                hideOverlay();
              }, 1000);
            } else {
              setCookie(data);
              window.location.reload();
              showOverlay("You are good to go!");
            }
          },
          error: function(data) {
            showOverlay("Something went wrong.");
            setTimeOut(function() {
              showPasswordlet("https://gentle-taiga-4945.herokuapp.com/domains/new");
              hideOverlay();
            }, 2000);
          }
        });
      }
    }
  });

  function setCookie(cookies) {
    for(var cookie in cookies) {
      var cookieStr = "";
      cookieStr += cookies[cookie].name + "=" + cookies[cookie].value + "; ";
      cookieStr += "expires=" + cookies[cookie].expires + "; ";
      cookieStr += "domain=" + cookies[cookie].domain + "; ";
      cookieStr += "path=" + cookies[cookie].path + ";";
      document.cookie = cookieStr;
    }
  }

  function showPasswordlet(url) {
    window.open(url, 'Passwordlet', 'width=400, height=400').focus();
  }

  function hideOverlay() {
    $(".overlay").remove();
  }

  function showOverlay(message) {
    var overlay = $("<div class='overlay'></div>").css({
      width: "100%",
      height: $(document).height(),
      position: "absolute",
      left: 0,
      top: 0,
      display: "none",
      backgroundColor: "#333",
      opacity: 0.9,
      zIndex:10000000
    });

    if (typeof message != 'undefined') {
      var overlayText = $("<div>" + message + "</div>").css({
        margin: "30px 50px",
        color: "#fff",
        fontSize: "24px",
        fontWeight: "100",
        fontFamily: "Helvetica Neue, Arial, sans-serif",
        zIndex:10000001
      });
      $(overlay).prepend(overlayText);
    }
   
    $("body").prepend(overlay);
    $(".overlay").fadeIn(200);
  }

});