(function(e,a,g,h,f,c,b,d){if(!(f=e.jQuery)||g>f.fn.jquery||h(f)){c=a.createElement("script");c.type="text/javascript";c.src="https://ajax.googleapis.com/ajax/libs/jquery/"+g+"/jquery.min.js";c.onload=c.onreadystatechange=function(){if(!b&&(!(d=this.readyState)||d=="loaded"||d=="complete")){h((f=e.jQuery).noConflict(1),b=1);f(c).remove()}};a.documentElement.childNodes[0].appendChild(c)}})(window,document,"1.3.2",function($,L){

  // showButton();
  showOverlay("Connecting to Passwordlet..");

  // $("#passwordlet-login-button").click(function (event) {
  //   event.preventDefault();

    $.ajax({
      type: "GET",
      url: "https://gentle-taiga-4945.herokuapp.com/domains/login",
      data: { domain: location.hostname },
      dataType: "jsonp",
      success: function(data) {
        debugger
        if (data == "domain not found") {
          showOverlay("This site is not registered in Passwordlet.");
        } else if (data == "not signed in") {
          showOverlay("You are not logged in");
        } else {
          console.log(data);
          setCookie(data);
          window.location.reload();
        }
      },
      error: function(data) {
        debugger
        showPasswordlet("https://gentle-taiga-4945.herokuapp.com/domains/")
      },
      jsonp: 'jsonp'
    });
  // });

  function setCookie(data) {
    var cookies = JSON.parse(data);
    for(var cookie in cookies) {
      var cookieStr = "";
      cookieStr += cookies[cookie].name + "=" + cookies[cookie].value + "; ";
      cookieStr += "expires=" + cookies[cookie].expires + "; ";
      cookieStr += "domain=" + cookies[cookie].domain + "; ";
      cookieStr += "path=" + cookies[cookie].path + ";";
      document.cookie = cookieStr;
    }
  }

  function showPasswordlet(url) {
    if ($(".passwordlet-frame").length == 0) {
      $('body').prepend("<div class='passwordlet-frame' style='margin: 0; padding: 0; border: 0; position: absolute; right: 20px; width: 400px; height: 400px; z-index: 10000000; box-shadow: 0px 0px 3px #ccc; background-color: #fff; margin: 20px 20px 0 0;'><object type='text/html' data='" + url + "' style='width:100%; height:100%;'></object><button class='close'>Close</button></div>");

      $(".close").click(function(event) {
        event.preventDefault();
        $(".passwordlet-frame").remove();
      });
    }
  }

  function showButton(message) {
    var button = $("<button id='passwordlet-login-button'>Login</button>").css({
      height: $(document).height(),
      position: "absolute",
      right: 10,
      top: 10,
      opacity: 0.9,
      zIndex:10000000
    });

    $("body").prepend(button);

  }

  function showOverlay(message) {
    var overlay = $("<div class='overlay'></div>").css({
      width: "100%",
      height: $(document).height(),
      position: "absolute",
      left: 0,
      top: 0,
      display: "none",
      backgroundColor: "#333",
      opacity: 0.9,
      zIndex:10000000
    });

    if (typeof message != 'undefined') {
      var overlayText = $("<span>" + message + "</span>").css({
        color: "#fff",
        fontSize: "50px",
        paddingTop: "100px",
        margin: "0 auto",
        fontFamily: "Helvetica Neue, Arial, sans-serif",
        zIndex:10000001
      });
      $(overlay).prepend(overlayText);
    }
   
    $("body").prepend(overlay);
    $(".overlay").fadeIn(1000, function() {
      setTimeout(function() {
        $(".overlay").fadeOut();  
      }, 3000);
    });
  }

});